<div ref:progressBar on:click='onPlayerClicked()'>
  <svg width="{{playerWidth}}px" height="24px" viewBox="0 0 {{playerWidth}} 24" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <defs>
        <circle id="path-1" cx="{{scrubberPos}}" cy="12" r="12"></circle>
    </defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Group" class="hoverable">
            <rect id="Rectangle-Copy" fill="#D8D8D8" x="2" y="11" width="{{completedWidth}}" height="7" rx="3.5"></rect>
            <rect id="Rectangle" stroke="#000000" stroke-width="2" x="6" y="9" width="{{timelineWidth}}" height="6" rx="3"></rect>
            <g id="Oval">
                <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#path-1"></use>
                <circle stroke="#000000" stroke-width="2" cx="{{scrubberPos}}" cy="12" r="11"></circle>
            </g>
        </g>
    </g>
  </svg>
</div>
<audio ref:audio id='pepino' src={{source}}></audio>
{{#if playerAvailable}}
  <button on:click='play()'>Play</button>
  <button on:click='pause()'>Pause</button>
  <button on:click='rewind()'>Rewind</button>
  <p>{{currentTime}}</p>
{{/if}}
<button on:click='toggle()'>Toggle</button>

<script>
  export default {
    oncreate () {
      const audioTag = this.refs.audio;
      window.audioTag = this.refs.audio;
      this.set({playerWidth: this.refs.progressBar.clientWidth});

      let destroyed = false;
      this.on( 'destroy', () => destroyed = true );

      const loop = () => {
        if ( destroyed ) return;
        requestAnimationFrame( loop );

        let progress = audioTag.currentTime / audioTag.duration;
        this.set({progress: progress});
        this.set({currentTime: progress});
      }

      loop();
    },

    data () {
      return {
        source: 'audio/kojan.mp3',
        currentTime: null,
        playerAvailable: true,
        progress: 0,
        playerWidth: 500,
        timelineWidth: 400,
        completedWidth: 250
      };
    },

    computed: {
      timelineWidth: playerWidth => playerWidth - 32,
      scrubberPos: (progress, timelineWidth) => {
        const pos = (timelineWidth * progress + 12).toFixed(1);
        return isNaN(pos)
          ? 0
          : pos;
      }
    },

    methods: {
      play: function () {
        const audioTag = this.refs.audio;
        audioTag.play();
      },
      pause: function () {
        const audioTag = this.refs.audio;
        audioTag.pause();
      },
      rewind: function () {
        const audioTag = this.refs.audio;
        audioTag.currentTime = 0;
      },
      onTimeUpdate: function () {
        const audioTag = this.refs.audio;
        this.set({currentTime: Math.floor(audioTag.currentTime)});
      },
      onPlayerClicked: function () {
        debugger;
      },
      toggle: function () {
        this.set({playerAvailable: !this.get('playerAvailable')});
      },
      kakota: function () {
        console.log('Soy kakota()');
      }
    }
  };
</script>

<style>
  .hoverable {
    cursor: pointer;
  }
</style>